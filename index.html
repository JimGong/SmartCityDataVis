<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
	<script src="https://d3js.org/topojson.v1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

	<script src='https://api.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.js'></script>
	<link href='https://api.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.css' rel='stylesheet'/>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

	<script src='JS/csv2geojson.js'></script>
	<script src='JS/moment.js'></script>
	<script src='JS/utility.js'></script>
	<script src='JS/jquery.csv.js'></script>
	<title>TEST</title>

</head>
<body>
	<div id='map' style='width: 100%; height: 700px;'></div>
	<script>

		mapboxgl.accessToken = 'pk.eyJ1IjoibWFnaWNiZWFyNzMwIiwiYSI6ImNqOWdnaThiNTJ1YnEzMm5ycTFtZTRsN2kifQ.mxWSrqZ6eSBBlgv3i7ZxuA';
		
		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/light-v9',
			center: [114.1,22.702053],
			zoom: 6,
		});

		var stationData_CSV = {}
		var stationData_GEOJSON = null;

		stationData_CSV = (function() {
			var stationData_CSV = null;
			$.ajax({
				'async': false,
				// 'global': false,
				type: "GET",
				url: 'data/toll_stations.csv',
				dataType: "text",
				success: function(csvData) {
					// console.log("csv",csvData);
					stationData_CSV = csvData;
					makeGeoJSON(csvData);
				}
			});
			return  stationData_CSV;
		})();

		stationData_CSV = $.csv.toObjects(stationData_CSV);

		function makeGeoJSON(csvData) {
			csv2geojson.csv2geojson(csvData, {
				latfield: 'Lat',
				lonfield: 'Lon',
				delimiter: ','
			}, function(err, data) {
				stationData_GEOJSON = data;

				map.on('load', function () {
					map.addLayer({
						'id': 'station',
						'type': 'circle',
						'source': {
							'type': 'geojson',
							'data': data
						},
						'paint': {
							"circle-radius":{
								'property': 'line',
								'type': 'categorical',
								'base': 1.75,
								'stops': [[6, 2], [22,180]]
							},
							"circle-color": "#1DC5B3",
						},
						"filter": ["==","$type", "Point"],
					});
				});    
			});
		}

		$(document).ready(function(){
			$.ajax({
				type: "GET",
				url: 'data/route_sorted.csv',
				dataType: "text",
				success: function(csvData){
					makeJSON(csvData);
				}
			})
		});

		function makeJSON(csvData){		

			var featurecollection = { type: 'FeatureCollection', features: [] };
			var fields = csvData.replace(/\n/g, ",").split(',');
			var enter_lat;
			var enter_lon;
			var exit_lat;
			var exit_lon;
			// console.log(fields);

			for(var i=10;i<fields.length; i=i+10){

				var line = {
					type: 'Feature',
					geometry: {
						type: 'LineString',
						coordinates: []
					}
				};
				enter_lat = parseFloat(fields[i+4]);
				enter_lon = parseFloat(fields[i+5]);
				exit_lat = parseFloat(fields[i+6]);
				exit_lon = parseFloat(fields[i+7]);

				if(enter_lat<0){
					enter_lat=null;
				};
				if(enter_lon<0){
					enter_lon=null;
				};
				if(exit_lat<0){
					exit_lat=null;
				};
				if(exit_lon<0){
					exit_lon=null;
				};
				line.geometry.coordinates.push([enter_lon,enter_lat]);
				line.geometry.coordinates.push([exit_lon,exit_lat]);
				featurecollection.features.push(line);
			}
			

			var geojson = {
				"type": "FeatureCollection",
				"features": [{
					"type": "Feature",
					"geometry": {
						"type": "LineString",
						"coordinates": [
						[0,0]
						]
					}
				}],
			};

			var speedFactor=300;
			var startTime=0;
			var progress=0;
			var count=0;

			map.on('load', function(){
				
				map.addLayer({
					'id':'route',
					'type': 'line',
					'source': {
						'type': 'geojson',
						'data': geojson,
					},
					'paint':{
						'line-width': 5.5,
						"line-color":"#ff9933",
					},
				})
				
				startTime= performance.now();
				// console.log(startTime);
				animateLine();

			});

			var speedFactor = 30; 

			function animateLine(timestamp){
				// console.log("called");
				// progress=timestamp-startTime;
				// console.log(featurecollection.features[count]);

				// console.log(featurecollection.features[count]);
				var startPoint=featurecollection.features[count].geometry.coordinates[0];

				var endPoint= featurecollection.features[count].geometry.coordinates[1];

				// console.log(startPoint, endPoint);

				var interval=(endPoint[0]-startPoint[0])/speedFactor;
				// console.log(geojson);
				geojson.features[0].geometry.coordinates=[];
				/* this is the old version 
				geojson.features.shift();
				geojson.features.push(featurecollection.features[count]);
				map.getSource('route').setData(geojson);
				*/

				var times=0;
				var slop = (startPoint[1]-endPoint[1])/(startPoint[0]-endPoint[0]);
				var b = startPoint[1] - slop*startPoint[0];

				function getY(x){
					var y= slop*(x)+b;
					return y;
				}

				function simpleFunc(){
					var x=startPoint[0]+ times*interval; 
					var y=getY(x);
					console.log(times,  [x,y]);
					geojson.features[0].geometry.coordinates.push([x,y]);
					map.getSource('route').setData(geojson);
					times++;

					if(times>30){
						clearInterval(t);

						if(count<featurecollection.features.length){
							animation=requestAnimationFrame(animateLine);	
						}else{
							console.log("Done");
							count=0;
							// animateLine();
							return;
						}
					}
				}

				var t= setInterval(simpleFunc, 100);

				count++;
				geojson.features[0].geometry.coordinates=[];


			}
		}

	</script>
</body>
</html>