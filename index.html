<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
	<script src="https://d3js.org/topojson.v1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

	<script src='https://api.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.js'></script>
	<link href='https://api.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.css' rel='stylesheet'/>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

	<script src='JS/csv2geojson.js'></script>
	<script src='JS/moment.js'></script>
	<script src='JS/utility.js'></script>
	<script src='JS/jquery.csv.js'></script>
	<title>TEST</title>

</head>
<body>
	<div id='map' style='width: 100%; height: 700px;'></div>
	<script>

		mapboxgl.accessToken = 'pk.eyJ1IjoibWFnaWNiZWFyNzMwIiwiYSI6ImNqOWdnaThiNTJ1YnEzMm5ycTFtZTRsN2kifQ.mxWSrqZ6eSBBlgv3i7ZxuA';
		
		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/light-v9',
			center: [114.1,22.702053],
			zoom: 6,
		});

		// map.scrollZoom.disable();
		var stationData={}
		stationData = (function() {
			var stationData = null;
			$.ajax({
				'async': false,
				// 'global': false,
				type: "GET",
				url: 'data/toll_stations.csv',
				dataType: "text",
				success: function(csvData) {
					// console.log("csv",csvData);
					stationData=csvData;
					makeGeoJSON(csvData);
				}
			});
			return  stationData;
		})();

		stationData= $.csv.toObjects(stationData);

		function makeGeoJSON(csvData) {
			csv2geojson.csv2geojson(csvData, {
				latfield: 'Lat',
				lonfield: 'Lon',
				delimiter: ','
			}, function(err, data) {
				map.on('load', function () {
					// console.log(data);
					map.addLayer({
						'id': 'station',
						'type': 'circle',
						'source': {
							'type': 'geojson',
							'data': data
						},
						'paint': {
							"circle-radius":{
								'property': 'line',
								'type': 'categorical',
								'base': 1.75,
								'stops': [[6, 2], [22,180]]
							},
							"circle-color": "#1DC5B3",
						},
						"filter": ["==","$type", "Point"],
					});
				});    
			});
		}

		// console.log(stationData[0]);

		$(document).ready(function(){
			$.ajax({
				type: "GET",
				url: 'data/data_sample.csv',
				dataType: "text",
				success: function(csvData){
					csvData= processFile(csvData);
					// csvData= $.csv.fromArrays(csvData);
					makeJSON(csvData);
				}
			})
		});

		function processFile(csvData){
			var allTextLines = csvData.split(/\r\n|\n/);
			var headers = allTextLines[0].split(',');
			var lines =[];

			for (var i=1; i<allTextLines.length; i++) {
				var data = allTextLines[i].split(',');
				if (data.length == headers.length) {
					var enter_roadId;
					var enter_stationId;
					var exit_roadId;
					var exit_stationId;

					var tarr = [];
					for (var j=0; j<headers.length; j++) {
						if(j==0){
							enter_roadId=data[j];
						}
						if(j==1){
							enter_stationId=data[j];
						}
						if(j==3){
							exit_roadId=data[j];
						}
						if(j==4){
							exit_stationId=data[j];
						}

						tarr.push(headers[j]+":"+data[j]);
					}

					var enter_station_lat = getLat(enter_roadId, enter_stationId, stationData);
					var enter_station_lon = getLon(enter_roadId, enter_stationId, stationData);
					var exit_station_lat = getLat(exit_roadId, exit_stationId, stationData);
					var exit_station_lon = getLon(exit_roadId, exit_stationId, stationData);


					tarr.push("Station_enter_Lat"+":"+ enter_station_lat);
					tarr.push("Station_enter_Lon"+":"+ enter_station_lon);
					tarr.push("Station_exit_Lat"+":"+ exit_station_lat);
					tarr.push("Station_exit_Lon"+":"+ exit_station_lon);
					lines.push(tarr);
				}
			}
			// console.log(lines);
			return lines;
		}

		function makeJSON(csvData){
			csv2geojson.csv2geojson(csvData,{
				latfield: 'Station_enter_Lat',
				lonfield: 'Station_enter_Lon',
				delimiter: ','
			}, function (err, data){
				if(err){
					console.log("there is an error");
				}else{
					console.log("successfully converted to geojson file");
				}
				map.on('load', function(){
					map.addLayer({
						'id':'route',
						'type': 'circle',
						'source': {
							'type': 'geojson',
							'data': data
						},
						'paint':{
							'circle-radius':{
								'property':'line',
								'type': 'categorical',
								'base': 1.75,
								'stops': [[6, 2], [22,180]],
							},
							'circle-color': "#f44842",
						},
						"filter": ["==","$type", "Point"],


					})
					console.log("done adding second layer");
				});
			})
		}

	</script>
</body>
</html>